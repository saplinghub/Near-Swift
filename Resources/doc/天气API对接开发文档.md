# 天气 API 对接开发文档

## 1. 概述
本文档记录了项目中和风天气（QWeather）接口的对接现状、技术实现及后续扩展计划。

---

## 2. 当前对接现状
| 接口类别 | 接口路径 | 对应功能模块 | 状态 | 技术要点 |
| :--- | :--- | :--- | :--- | :--- |
| **实时天气** | `weather/now` | 首页温湿度、描述展示 | 已集成 | 1分钟防抖刷新，支持 40 种以上天气图标映射 |
| **每日预报** | `weather/3d` | 首页未来 3 天概览 | 已集成 | 支持最高/最低温展示、天气趋势图标 |
| **生活指数** | `indices/1d` | 首页展示 + 详情卡片 | 已集成 | 请求类型限定为：`1,3,5,8`（运动、穿衣、钓鱼、旅游） |
| **空气质量(V1)**| `/airquality/v1/current/{lat}/{lon}` | 首页空气质量标签 | 已集成 | 采用路径参数格式，经纬度保留两位小数 |
| **分钟级降水**| `minutely/5m` | 地点详情摘要 | 已集成 | 基于经纬度（Lon, Lat）获取未来 2 小时精准摘要 |
| **地理搜索** | `geo/city/lookup`| 设置页城市检索 | 已集成 | 支持多级行政区划筛选 |

---

## 3. 核心技术实现

### 3.1 动态 HOST 与 URL 拼接规范
为支持 QWeather 不同版本的接口（如 V7 天气接口与 V1 空气质量接口），系统采用了**纯净 HOST + 动态路径**的拼接模式：

1. **HOST 配置**：在设置中应仅配置域名或代理基址，**不要**包含 `/v7` 等路径。
    *   **推荐值**：`https://devapi.qweather.com` 或 `https://nc7h2r9xxe.re.qweatherapi.com`
2. **拼接逻辑示例**：
    *   **常规天气 (V7)**：`{HOST}/v7/weather/now`
    *   **指数接口 (V7)**：`{HOST}/v7/indices/1d`
    *   **空气质量 (V1)**：`{HOST}/airquality/v1/current/{lat}/{lon}`
3. **安全性**：系统会自动处理配置末尾的斜杠 (`/`)，确保拼接后的 URL 合法。

### 3.2 智能刷新机制
- **缓存策略**：10分钟强缓存，1分钟软刷新（防止过度调用 API）。
- **后台轮询**：APP 运行期间每 30 分钟进行一次静默更新。
- **强制刷新**：切换地点或手动点击刷新图标会无视缓存立即请求。

### 3.3 UI 布局规范
- **Header 区域**：左侧固定气温区（90pt），中间为动态扩容区，右侧为精简预报。
- **指数项目**：
    - **首页**：仅展示“空气质量”与“紫外线”。
    - **详情页**：精选展示 **运动 (1)**、**穿衣 (3)**、**钓鱼 (5)**、**旅游 (8)** 四项核心建议。
- **语义增强**：空气质量映射现已覆盖“极好”、“各适宜”等多种 API 返回变体，统一转化为“空气 优/良/污染”体系。

---

## 4. 后续扩展计划
- [ ] **灾害预警** (`warning/now`)：监测暴雨、台风等极端天气。
- [ ] **天文数据** (`astronomy/sun`)：详情页展示日出/日落时间。

---

## 5. 对接要求
1. **动态配置**：禁止硬编码 HOST，必须读取 `UserDefaults` 中的 `qWeatherHost`。
2. **错误处理**：所有 API 聚合必须使用 `Publishers.Zip` 的 Catch 容错，确保单一接口失败不影响全局加载。


