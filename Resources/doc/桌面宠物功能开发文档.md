# 桌面宠物 (Near Pet) 开发文档

本文档详细说明了 "Near" 项目中桌面宠物辅助功能的开发实现，旨在利用 macOS 原生特性打造一个灵动、低耗且具有陪伴感的桌面交互伙伴。

## 1. 技术路线 (Technical Stack)

| 维度 | 方案 | 理由 |
| :--- | :--- | :--- |
| **容器层** | `NSPanel` (Custom `NSWindow`) | 支持透明背景、点击穿透、全空间 (Spaces) 漫游、非激活态。 |
| **渲染层** | SwiftUI + `CALayer` | 声明式界面开发，利用原生动效引擎，支持高质量模糊材质。 |
| **边界管理** | `NSScreen.visibleFrame` | 实时计算有效显示区域，物理排斥 Dock 栏与菜单栏区域。 |
| **物理逻辑** | 状态机 (idle, walking, docked) | 区分自由行动与边缘交互逻辑。 |

---

## 2. 核心机制实现 (Core Mechanisms)

### 2.1 侧头窥视式贴边 (Peeking Docking)
- **触发条件**：当宠物窗口中心距离可见屏幕边缘小于 80px 时触发。
- **视觉表现**：同步进行 `0.75x` 比例缩放，并向边缘对齐，呈现出一半由于贴边被“切掉”的效果。
- **避障逻辑**：通过 `visibleFrame` 差值自动识别 Dock 栏方位，禁止在 Dock 侧吸附，防止被系统 UI 遮挡或导致用户无法回收。

### 2.2 自由意识 (Self-Awareness)
- **随机漫步**：闲置状态下有 5% 概率随机在屏幕 `visibleFrame` 区域内寻找新锚点并移动。
- **环境交互**：贴边或漫步结束后，宠物会根据状态发出气泡文本（如“潜伏中”、“散步真开心”）。

### 2.3 极致轻量 (Performance First)
- **事件驱动**：仅在 Timer 触发（0.1s）或状态变化时更新 UI 属性。
- **资源占用**：当前 CPU 占用率极低 (<0.1%)，且利用 Core Animation 进行 GPU 渲染，不产生过量的重绘开销。

---

## 3. 功能进度 (Feature Roadmap)

### 第一阶段：核心架构 (P0 - 已完成)
- [x] 透明 `NSPanel` 容器与 SwiftUI 视图集成。
- [x] 物理边界判定（避开 Dock 栏）。
- [x] **贴边缩小机制**：替代回弹算法，解决物理震荡问题。

### 第二阶段：灵动交互 (P1 - 进行中)
- [x] **窥视视觉效果**：边缘缩放与光环偏移处理。
- [x] **自由行动**：随机漫步巡逻。
- [x] **对话气泡**：支持状态相关的气泡提醒。
- [x] **系统感知**：将 CPU/负载映射为宠物的光环颜色。

### 第三阶段：扩展能力 (P2 - 已完成)
- [x] **交互消息语义化**：区分提示与交互，引入水平胶囊按钮布局。
- [x] **智能天气系统**：支持全天候首报与突变感知。
- [x] **拟人化时间感知**：基于 24 小时制的动态问候语。
- [x] **日志量化统计**：支持本地健康与交互日志的深度 AI 分析。
- [ ] **用户操作感知 (趣味互动)**：监听应用、活跃度，生成本地日志，联动 AI 判断状态。
- [ ] **电子围栏**：允许用户限制宠物的活动屏幕或特定区域。
- [ ] **AI 智脑**：联动后端 AI，使其能基于上下文与用户简单对话。

---

## 4. 扩展探索：用户操作感知与趣味互动 (User Intent Awareness)

### 4.1 技术要点 (Technical Key Points)
1. **应用切换监控**：利用 `NSWorkspace.shared.notificationCenter` 监听 `didActivateApplicationNotification`，实时感知用户正在使用的 App。
2. **活跃度采样**：
    - **键盘/鼠标频率**：通过 `CGEvent.tapCreate` (Event Tap) 统计单位时间内的点击/敲击次数（非记录内容，仅统计频率）。
    - **闲置检测**：通过 `CGEventSource.secondsSinceLastEventType` 判断用户是否离开或正在发呆。
3. **UI 元素探测 (高级)**：利用 `AXUIElement` (Accessibility API) 识别当前窗口的标题或关键控件（如：检测到处于“代码编辑器”且长时间无输入）。

### 4.2 难点与挑战 (Technical Difficulties)
- **权限门槛**：**Accessibility (辅助功能)** 权限是必选项。如果用户不授予，功能将完全停摆，且审核较严。
- **隐私保护**：必须明确告知用户仅记录“统计信息”（如：你已经看了 2 小时 Bilibili 了）而非具体内容（如：搜索词或聊天记录），否则易引起反感。
- **互动噪声**：拟人化互动需要精密的“冷却时间”逻辑，否则宠物会像个监控摄像头一样令人紧张。

### 4.3 趣味互动玩法建议 (Playability)
- **勤奋鼓励**：检测到 Xcode 活跃且打字起飞时，宠物在角落做“加油”动作，气泡显示“主人手速惊人！”。
- **摸鱼吐槽**：检测到浏览器在购物/视频站停留过久，宠物侧头窥视并吐槽“老板在看你哦...”。
- **深夜关心**：检测到凌晨 2 点仍在活跃，宠物变红并强制进入“困倦”状态，提示“早点睡吧，我都不行了”。

### 4.4 可行性评估与 AI 联动 (Enhanced AI Logic)
- **本地日志策略**：所有的操作频次记录于本地 `~/Library/Application Support/Near/InteractionLogs/`，系统每日凌晨自动清理 24 小时前的日志，确保绝不上传，保护隐私。
- **简单场景 (Direct Rules)**：
    - 切到 Xcode -> 提示“主人加油，代码写累了休息下”。
    - 切到 购物网站 -> 提示“钱包在哭泣，别买啦”。
- **复杂场景 (AI Reasoning)**：
    - 逻辑：当用户在某个页面停留超过 15 分钟且输入频率极低。
    - 行为：主动采集最近 3 次 App 切换记录，调用 AI：“用户最近在用 X、Y、Z，当前停留在 Z 且无输入，请给出一句拟人化的、调皮的调侃语”。
    - 效果：宠物可能会说“这个页面盯着 10 分钟了，是在思考人生还是在发呆？”

---

## 5. 展望：健康提醒与天气交互 (Health & Weather Insights)

### 5.1 交互气泡升级 (Interactive Bubble)
- **精准识别**：气泡按钮仅在包含“水”、“腰”、“站”、“天气”、“问候”等关键语义时保留。
- **视觉反馈**：通过精致的小型 Capsule 按钮确认状态（如“朕知道了”、“喝水了”），数据同步记入本地健康日志。

### 5.2 智能天气系统 (Weather Insight)
- **首报机制**：每日首次激活宠物时（无论早晚），触发时间敏感的问候语（如“这么晚还没睡呀”），并询问是否需要同步今日天气大纲。
- **突变监测**：
    - **自动检测**：背景静默监听温度波动（>5°C）或天气现象变化（雨/雪起止）。
    - **无感提醒**：突变时弹出纯气泡通知，不携带确认按钮，减少干扰。

### 5.3 行为记录与每日汇总
- **健康简报**：每天 17:30 自动聚合当日喝水/站立数据，生成情感化总结。
- **AI 赋能**：联动 `LogAnalysisManager` 与 `AIService`，对海量本地日志进行“脱敏总结”，为用户提供带调侃语气的周/月行为分析建议。

### 5.4 权限与存储
- [x] **本地化**：记录同样仅存于本地，支持在设置页面一键清理统计数据。
- [x] **自定义**：允许用户自定义提醒间隔及汇总时间。

---

## 6. 通知等级与等级抑制系统 (Notification Tier & Suppression)

为了提供更人性化的陪伴体验而不至于成为“骚扰源”，系统建立了一套完整的通知分级与状态感知抑制机制。

### 6.1 通知分级定义 (Notification Tiers)

| 等级 | 级别 (Level) | 典型场景 | 冷却时间 (CD)示例 | 抑制逻辑 |
| :--- | :--- | :--- | :--- | :--- |
| **一级 (Critical)** | 1 | 健康提醒、极端的恶劣天气警告、每日首报 | 几乎无 (5s) | **强制送达**：不受宠物贴边或缩起状态影响，优先保证用户健康。 |
| **二级 (Important)** | 2 | 日常天气变动提示、周期性固定日程 | 5 分钟 | **常规抑制**：贴边或缩起时，冷却时间延长至 15 分钟（3倍）。 |
| **三级 (Normal)** | 3 | 系统负载变化吐槽、应用切换互动、发呆调侃 | 10 分钟 | **深度抑制**：贴边或缩起时，冷却时间延长至 50 分钟（5倍）。 |

### 6.2 通知分类 (Notification Types)

通过分类标签实现更精准的语义识别与数据统计：
- `health`: 喝水、久坐提醒。
- `interaction`: 应用切换感应、输入频率反馈。
- `fun`: 漫步后的随口调侃。
- `system`: CPU 负载、电池电量等硬件感知。
- `weather`: 实时天气现象变化。

### 6.3 贴边抑制策略 (Docked Suppression)

系统通过 `notify` 统一接口实现这一机制：
1. **状态感知**：当 `model.isDocked` 为 `true` 时，系统自动识别出用户当前可能处于专注工作或不希望被打扰的状态。
2. **动态平衡**：
   - 绝大多数“趣味级”通知将进入极长冷却。
   - 气泡文本展示时长从变动的字数适配，缩减为统一的 5 秒内快速消失，减少视觉停留带来的心智负担。
3. **未读复读机制**：针对“每日天气首报”等重要但可能被忽略的通知，若用户未在当前轮次点击“朕知道了”，系统将自动进入 30-60 分钟的静默期，过期后再次尝试唤起。
